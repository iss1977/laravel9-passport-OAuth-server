# Laravel Passport Oauth Server 


## Development steps:


Setting up __http://laravel-passport-server.test/__ in Apache

Using config:

```
<VirtualHost 127.0.0.2:80>
	DocumentRoot "C:/Laravel/Laravel Passport OAuth server and client 03.2022/laravel9-passport-server/public"
	ServerName laravel-passport-server.test
	DirectoryIndex index.php
	ErrorLog "C:/Laravel/Laravel Passport OAuth server and client 03.2022/laravel9-passport-server/apache-error.log"	
    CustomLog "C:/Laravel/Laravel Passport OAuth server and client 03.2022/laravel9-passport-server/access.log" common	
	<Directory "C:/Laravel/Laravel Passport OAuth server and client 03.2022/laravel9-passport-server/public">
		Options Indexes FollowSymLinks MultiViews
		AllowOverride all
		Order Deny,Allow
		Allow from all
		Require all granted
	</Directory>
</VirtualHost>
```

in ```C:\xampp\apache\conf\extra``` and  ```Windows host``` file.

- Adding auth scaffolding with Laravel/UI.
- Creating view model, migrations, controllers and seeders for Posts.
    User with email 'admin@test.com' and password '12345678' will be created when seeded for admin login.
    Other 20 users and 25 Posts per user are created by seed.
- Install & configure Passport -> Laravel Docs.
- Adding Json Resources for Users and Posts + Api Controller + api Route to be able to test the results.
- Creating view and controller for displaying and creating users clients.
- Testing functionality of the OAuth server: autorization code, aquire token, refresh token.
- Creating a post through an API call.
- creating scopes for the clients and authorization tokens.
- Setting up scopes for OAuth tokens.


## Autorization process :

</br>

### __Obtaining an authorization code__

</br>

Client ( other application ) will be redirected to the OAuth Server webpabe with a get request to the endpoint of this app have the following Query Params: 

```
client_id:1 (client ID)
redirect_uri:http://other-app.test/callback (after the authorization = user will be presented with a form, and he will confirm the authorization= , this app will redirect client app to this url)
response_type:code (other app needs a code to obtain the OAuth Token)
scope: (not filled)
state:asdfasdfasdfasdfasdfasdfasdfasdfasdfasdf (any 40 char string)
```

The query string looks like this: 

```http://laravel-passport-server.test/oauth/authorize?client_id=1&redirect_uri=http://laravel9-passport-server.test/auth/callback&response_type=code&scope&state=asdfasdfasdfasdfasdfasdfasdfasdfasdfasdf```

This get request will be generated by the client application. The redirect must be done to force the user to log in on the from servergenerated  web page with his credentials to verify the identity. 

If using postman, we can simulate this using laravel session cookies added to the header of the request.

</br>

### __Granting or denieing the authorisation__

</br>

As part of the authorisation, the OAuth server generated page will present to the user a consent form, with 2 buttons :

```
	<!-- Authorize Button -->
    <form method="post" action="http://laravel-passport-server.test/oauth/authorize">
        <input type="hidden" name="_token" value="BiHLiTDi01buXohLLHlKGpeUYMt2v7b30SJh84N6">
        <input type="hidden" name="state" value="asdfasdfasdfasdfasdfasdfasdfasdfasdfasdf">
        <input type="hidden" name="client_id" value="1">
        <input type="hidden" name="auth_token" value="VGSY08YuhDfDdo5j">
        <button type="submit" class="btn btn-success btn-approve">Authorize</button>
    </form>

    <!-- Cancel Button -->
    <form method="post" action="http://laravel-passport-server.test/oauth/authorize">
        <input type="hidden" name="_token" value="BiHLiTDi01buXohLLHlKGpeUYMt2v7b30SJh84N6">
        <input type="hidden" name="_method" value="DELETE">
        <input type="hidden" name="state" value="asdfasdfasdfasdfasdfasdfasdfasdfasdfasdf">
        <input type="hidden" name="client_id" value="1">
        <input type="hidden" name="auth_token" value="VGSY08YuhDfDdo5j">
        <button class="btn btn-danger">Cancel</button>
    </form>
```


</br>

### __Redirecting the user to the client app__

</br>

After the user chooses "Authorize", the response will be : 
Status Code: 302 Found, redirect to the client app url, specified by the initial get request and a code to be used to obtain the token.

```
http://other-app.test/callback?code=def50200c00 .... 4b73bf4c64985a5f246508&state=asdfasdfasdfasdfasdfasdfasdfasdfasdfasdf
```

</br>

### __Obtaining the OAuth token__

</br>

Next step is to send the request to optain the token :

Send a POST Request to our oath server with slug /oath/token with the following form data:

```
grant_type:authorization_code
client_id:3
client_secret:U6D8XAvU4IVPuJyCWfP2ydKPrX2IrnTEuyhiqJyR
redirect_uri:http://other-app.test/callback
code:def5 ...... 10c43
```

_Note : code is 700 char long_


</br>

### __Requesting a refresh token__

</br>



Send a POST Request to our oath server with slug /oath/token with the following form data:

```
client_id:5
redirect_uri:http://my-external-app.test
grant_type:refresh_token
client_secret:U494E1ZFUO1hu8r9VyKOTqyTnpWcJydyc1DRAbPU
refresh_token:def50200 .... ba57551d
```

The response will be like :

```json
{
    "token_type": "Bearer",
    "expires_in": 1296000,
    "access_token": "ey  ........   UIlwA",
    "refresh_token": "def5...........1def5"
}
```

_Note: tokens are 1000 char long_

Now. it's posible to make requests to the server Backend using the access token as an authorized user.

An example of a valid request would be ...

```bash
curl --location --request GET 'http://laravel-passport-server.test/api/user' \
    --header 'Accept: application/json' \
    --header 'Authorization: Bearer eyJ0 ...... rE8'
```

_Note Authorization: Bearer is 1000 char long_

There is also a posibillity to create tokens with a specific scope.
Scopes are defined in ```AuthServiceProvider ```.

also, the middlewares must be registred in the ```app/Http/Kernel.php``` file: 
```php
    protected $routeMiddleware = [
        ...
        'scopes' => \Laravel\Passport\Http\Middleware\CheckScopes::class,
        'scope' => \Laravel\Passport\Http\Middleware\CheckForAnyScope::class,
    ];
```
then, the routes can be protected by this 2 middlewares:

```php
Route::middleware(['auth:api','scopes:get-email'])->get('/user', function (Request $request) {
    return $request->user()->makeVisible(['email']);
});
```

Thanks goes to Andrew Schmelyun
